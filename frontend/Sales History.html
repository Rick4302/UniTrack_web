<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniTrack - Sales History</title>
    <style>
        /* (kept your original styles) */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url("payhigh.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(65, 105, 225, 0.75), rgba(100, 149, 237, 0.75));
            z-index: 1;
        }

        .page-container {
            position: relative;
            z-index: 2;
            min-height: 100vh;
        }

        .top-nav {
            width: 100%; height: 70px;
            background-color: #4169E1;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; position: fixed; top: 0; left: 0; z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-left { display: flex; align-items: center; gap: 20px; }

        .back-button {
            width: 40px; height: 40px;
            background: rgba(255,255,255,0.15); border: none; border-radius: 50%;
            color: #FFD700; font-size: 20px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        
        .back-button:hover { background: rgba(255,255,255,0.25); transform: translateX(-3px); }

        .logo { font-size: 24px; font-weight: bold; color: #FFD700; }
        .page-title { font-size: 22px; font-weight: bold; color: #fff; }

        .main-content {
            padding: 100px 40px 40px; min-height: 100vh;
            max-width: 1400px; margin: 0 auto;
        }

        .filter-panel {
            background: rgba(255,255,255,0.95); border-radius: 12px;
            padding: 20px 25px; margin-bottom: 20px;
            display: flex; gap: 15px; align-items: center; flex-wrap: wrap;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .filter-panel input, .filter-panel select, .filter-btn {
            padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px;
            font-size: 14px; font-weight: 600; transition: all 0.3s ease;
        }
        
        .filter-panel input { width: 250px; background: #fff; color: #333; }
        .filter-panel select { width: 180px; background: #fff; color: #333; cursor: pointer; }
        .filter-panel input:focus, .filter-panel select:focus { border-color: #4169E1; outline: none; }

        .filter-btn { background: #4169E1; color: #fff; border-color: #4169E1; cursor: pointer; }
        .filter-btn:hover { background: #3558d1; transform: translateY(-2px); }

        .data-grid-container {
            background: rgba(255,255,255,0.95); border-radius: 12px;
            overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: calc(100vh - 280px); overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; }
        
        th {
            background: linear-gradient(135deg, #4169E1, #3558d1);
            color: #fff; padding: 16px; text-align: left;
            font-weight: 600; font-size: 13px; position: sticky; top: 0; z-index: 10;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        td { padding: 14px 16px; border-bottom: 1px solid #e0e0e0; font-size: 14px; color: #333; }
        tr:hover { background: rgba(65,105,225,0.05); }

        .status-badge {
            padding: 6px 12px; border-radius: 20px;
            font-weight: 600; font-size: 12px;
            text-align: center; display: inline-block;
        }

        .status-approved {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .status-rejected {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
        }

        .payment-type {
            padding: 4px 12px; border-radius: 6px;
            font-size: 12px; font-weight: 600;
            text-align: center; display: inline-block;
        }

        .payment-cash { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .payment-gcash { background: rgba(33, 150, 243, 0.2); color: #2196F3; }

        .action-btn {
            padding: 6px 12px; border: none; border-radius: 6px;
            font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease; margin-right: 5px;
        }

        .view-btn { background: #4169E1; color: #fff; }
        .view-btn:hover { background: #3558d1; }

        .no-data { text-align: center; padding: 60px; color: #666; font-size: 16px; }
        .loading { text-align: center; padding: 40px; color: #4169E1; }

        .data-grid-container::-webkit-scrollbar { width: 10px; }
        .data-grid-container::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .data-grid-container::-webkit-scrollbar-thumb { background: #4169E1; border-radius: 5px; }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            justify-content: center; align-items: center; z-index: 2000;
        }

        .modal-overlay.active { display: flex; }

        .modal-content {
            background: #fff; padding: 30px; border-radius: 16px;
            width: 90%; max-width: 600px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h3 { margin-bottom: 20px; color: #333; font-size: 22px; }

        .order-details { margin-bottom: 20px; }

        .detail-row {
            display: flex; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: 600; color: #555; }
        .detail-value { color: #333; }

        .modal-buttons { display: flex; gap: 15px; margin-top: 25px; }

        .modal-btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }

        .modal-btn-cancel { background: #e0e0e0; color: #333; }
        .modal-btn-cancel:hover { background: #d0d0d0; }

        .alert-modal .modal-content { max-width: 450px; text-align: center; }
        .alert-icon { font-size: 50px; margin-bottom: 15px; }
        .alert-message { color: #666; line-height: 1.6; margin-bottom: 20px; }
        .alert-modal .modal-btn { background: #4169E1; color: #fff; }
        .alert-modal .modal-btn:hover { background: #3558d1; }

        @media (max-width: 900px) {
            .main-content { padding: 100px 20px 40px; }
            .filter-panel { flex-direction: column; align-items: stretch; }
            .filter-panel input, .filter-panel select, .filter-btn { width: 100%; }
            table { font-size: 12px; }
            td, th { padding: 10px 8px; }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <nav class="top-nav">
            <div class="nav-left">
                <button class="back-button" onclick="goBack()">‚Üê</button>
                <div class="logo">UniTrack</div>
                <span class="page-title">Sales History</span>
            </div>
        </nav>

        <main class="main-content">
            <div class="filter-panel">
                <input type="text" id="searchBox" placeholder="Search by name, product, or order ID...">
                <select id="statusFilter">
                    <option value="">All Status</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <select id="paymentFilter">
                    <option value="">All Payment Types</option>
                    <option value="Cash">Cash</option>
                    <option value="GCash">GCash</option>
                </select>
                <button class="filter-btn" onclick="applyFilter()">FILTER</button>
            </div>

            <div class="data-grid-container">
                <table id="salesHistoryTable">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Student Number</th>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Total Amount</th>
                            <th>Payment Type</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesHistoryTableBody">
                        <tr>
                            <td colspan="9" class="loading">Loading sales history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="orderModal">
        <div class="modal-content">
            <h3>Order Details</h3>
            <div class="order-details" id="orderDetails"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay alert-modal" id="alertModal">
        <div class="modal-content">
            <div class="alert-icon" id="alertIcon">‚ÑπÔ∏è</div>
            <h3 id="alertTitle">Alert</h3>
            <p class="alert-message" id="alertMessage"></p>
            <button class="modal-btn" onclick="closeAlertModal()" style="width:100%;">OK</button>
        </div>
    </div>

    <script>
    
    const API_BASE = 'http://localhost/UniTrack_web/backend';
    let allSalesHistory = [];

    window.addEventListener('DOMContentLoaded', () => {
        const adminEmail = sessionStorage.getItem('adminEmail');
        if (!adminEmail) {
            // If your app uses sessionStorage for admin login, ensure this is set.
            // Comment out the redirect while debugging if you want to bypass login check.
            window.location.href = 'Admin%20Login.html';
            return;
        }
        
        loadSalesHistory();
    });

    async function loadSalesHistory() {
        const tbody = document.getElementById('salesHistoryTableBody');
        tbody.innerHTML = '<tr><td colspan="9" class="loading">Loading sales history...</td></tr>';

        try {
            // <-- MAIN FIX: use the existing backend file name you provided
            const response = await fetch(`${API_BASE}/get_sales_history.php`, {
                method: 'GET',
                credentials: 'include' // include cookies if your server relies on sessions
            });

            // Helpful logs for debugging
            console.log('HTTP status for get_sales_history.php:', response.status, response.statusText);

            // Validate response is JSON
            let result;
            try {
                result = await response.json();
            } catch (parseErr) {
                console.error('Response was not valid JSON:', await response.text());
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">Server returned invalid JSON</td></tr>';
                return;
            }

            console.log('API Response:', result);

            if (!response.ok) {
                const msg = result && result.message ? result.message : 'Server error';
                tbody.innerHTML = `<tr><td colspan="9" class="no-data">Error: ${escapeHtml(msg)}</td></tr>`;
                return;
            }

            if (result.status === 'success') {
                allSalesHistory = Array.isArray(result.data) ? result.data : [];
                renderSalesHistory(allSalesHistory);
                
                if (allSalesHistory.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="no-data">No sales history found</td></tr>';
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="9" class="no-data">Error: ' + escapeHtml(result.message || 'Unknown error') + '</td></tr>';
            }
        } catch (error) {
            console.error('Error fetching sales history:', error);
            tbody.innerHTML = '<tr><td colspan="9" class="no-data">Failed to connect to server</td></tr>';
        }
    }

 function isApprovedStatus(statusText) {
  if (!statusText && statusText !== 0) return false;
  const s = String(statusText).trim().toLowerCase();
  // treat these as approved
  const approved = ['approved', 'paid', 'completed', 'done'];
  return approved.includes(s);
}

function renderSalesHistory(transactions) {
  const tbody = document.getElementById('salesHistoryTableBody');

  if (!Array.isArray(transactions) || transactions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="no-data">No transactions to display</td></tr>';
    return;
  }

  tbody.innerHTML = transactions.map(order => {
    const statusText = order.Status || '';
    const approved = isApprovedStatus(statusText);
    const statusClass = approved ? 'status-approved' : 'status-rejected';
    const statusBadge = approved ? '‚úÖ Approved' : (String(statusText) || '‚ùå Rejected');

    const paymentClass = (order.PaymentType || '').toLowerCase() === 'gcash' ? 'payment-gcash' : 'payment-cash';
    const paymentBadge = (order.PaymentType || '').toLowerCase() === 'gcash' ? 'üì± GCash' : 'üí∞ Cash';
    const orderDate = formatDate(order.OrderDate);

    return `
      <tr>
        <td>#${order.OrderID}</td>
        <td>${escapeHtml(order.StudentID)}</td>
        <td>${escapeHtml(order.ItemName)}</td>
        <td>${order.Quantity}</td>
        <td>‚Ç±${parseFloat(order.FinalAmount || order.TotalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</td>
        <td><span class="payment-type ${paymentClass}">${paymentBadge}</span></td>
        <td><span class="status-badge ${statusClass}">${statusBadge}</span></td>
        <td>${orderDate}</td>
        <td>
          <button class="action-btn view-btn" onclick="viewOrderDetails(${order.OrderID})">View</button>
        </td>
      </tr>
    `;
  }).join('');
}
    async function viewOrderDetails(orderId) {
        const order = allSalesHistory.find(o => o.OrderID === orderId);
        
        if (!order) {
            showAlert('‚ö†Ô∏è', 'Not Found', 'Order details not found.');
            return;
        }

        let detailsHtml = `
            <div class="detail-row">
                <span class="detail-label">Order ID:</span>
                <span class="detail-value">#${order.OrderID}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Student Number:</span>
                <span class="detail-value">${escapeHtml(order.StudentID)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Product:</span>
                <span class="detail-value">${escapeHtml(order.ItemName)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Size:</span>
                <span class="detail-value">${escapeHtml(order.Size)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Quantity:</span>
                <span class="detail-value">${order.Quantity}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Total Amount:</span>
                <span class="detail-value">‚Ç±${parseFloat(order.TotalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Discount Amount:</span>
                <span class="detail-value">‚Ç±${parseFloat(order.DiscountAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Final Amount:</span>
                <span class="detail-value"><strong>‚Ç±${parseFloat(order.FinalAmount || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</strong></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Payment Type:</span>
                <span class="detail-value">${(order.PaymentType || '').toLowerCase() === 'gcash' ? 'üì± GCash' : 'üí∞ Cash'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value">${order.Status === 'Approved' ? '‚úÖ Approved' : '‚ùå Rejected'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Order Date & Time:</span>
                <span class="detail-value">${formatDateTime(order.OrderDate)}</span>
            </div>
        `;

        if (order.Status === 'Rejected' && order.RejectionReason) {
            detailsHtml += `
                <div class="detail-row">
                    <span class="detail-label">Rejection Reason:</span>
                    <span class="detail-value" style="color: #F44336;">${escapeHtml(order.RejectionReason)}</span>
                </div>
            `;
        }

        if ((order.PaymentType || '').toLowerCase() === 'gcash' && order.HasGCashReceipt) {
            detailsHtml += `
                <div class="detail-row">
                    <span class="detail-label">GCash Receipt:</span>
                    <span class="detail-value">
                        <button class="modal-btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #4169E1; color: #fff;" onclick="viewImage(${order.OrderID}, 'gcash')">
                            üì∏ View Receipt
                        </button>
                    </span>
                </div>
            `;
        }

        if (order.HasDiscount && order.HasDiscountImage) {
            detailsHtml += `
                <div class="detail-row">
                    <span class="detail-label">PWD/Senior ID:</span>
                    <span class="detail-value">
                        <button class="modal-btn" style="padding: 6px 12px; font-size: 12px; width: auto; background: #4169E1; color: #fff;" onclick="viewImage(${order.OrderID}, 'discount')">
                            üìã View ID
                        </button>
                    </span>
                </div>
            `;
        }

        document.getElementById('orderDetails').innerHTML = detailsHtml;
        document.getElementById('orderModal').classList.add('active');
    }

    function viewImage(orderId, imageType) {
        const imageUrl = `${API_BASE}/get_orders_images.php?orderId=${orderId}&type=${imageType}`;
        const title = imageType === 'gcash' ? 'GCash Receipt' : 'PWD/Senior Citizen ID';
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.id = 'imageViewerModal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <h3>${title}</h3>
                <img src="${imageUrl}" alt="${title}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22>Image not available</text></svg>'" style="width: 100%; max-height: 600px; object-fit: contain; border-radius: 8px; margin: 20px 0; background: #f5f5f5;">
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="document.getElementById('imageViewerModal').remove()">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function applyFilter() {
        const searchText = document.getElementById('searchBox').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const paymentFilter = document.getElementById('paymentFilter').value;

        let filtered = allSalesHistory.filter(order => {
            const matchSearch = !searchText || 
                String(order.StudentID).toLowerCase().includes(searchText) ||
                (order.ItemName || '').toLowerCase().includes(searchText) ||
                String(order.OrderID).includes(searchText);

            const matchStatus = !statusFilter || order.Status === statusFilter;
            const matchPayment = !paymentFilter || (order.PaymentType || '').toLowerCase() === paymentFilter.toLowerCase();

            return matchSearch && matchStatus && matchPayment;
        });

        renderSalesHistory(filtered);
    }

    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('en-US', { 
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
        });
    }

    function closeModal() {
        document.getElementById('orderModal').classList.remove('active');
    }

    function showAlert(icon, title, message) {
        document.getElementById('alertIcon').textContent = icon;
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertMessage').textContent = message;
        document.getElementById('alertModal').classList.add('active');
    }

    function closeAlertModal() {
        document.getElementById('alertModal').classList.remove('active');
    }

    function goBack() {
        window.location.href = 'Admin Dashboard.html';
    }

    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => {
            if (e.target === modal) modal.classList.remove('active');
        });
    });

    document.getElementById('searchBox').addEventListener('keyup', applyFilter);
</script>
</body>
</html>